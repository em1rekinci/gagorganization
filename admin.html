<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAG Quiz ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #08080e;
    --surface: #111118;
    --card: #16161f;
    --border: #252532;
    --accent: #ff6b35;
    --accent2: #ffd23f;
    --text: #e8e8f0;
    --muted: #555570;
    --green: #4ade80;
    --red: #f87171;
    --blue: #60a5fa;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  
  /* LOGIN */
  .login-wrap {
    min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;
  }
  .login-box { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 2.5rem; width: 100%; max-width: 380px; }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 3px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.2rem; }
  .logo-sub { color: var(--muted); font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2rem; }
  label { display: block; font-size: 0.72rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.45rem; }
  input[type="password"] {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 0.8rem 1rem; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 1rem;
    outline: none; transition: border-color 0.2s; margin-bottom: 1rem;
  }
  input:focus { border-color: var(--accent); }
  .btn { width: 100%; padding: 0.85rem; border-radius: 10px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600; transition: all 0.2s; }
  .btn-primary { background: linear-gradient(135deg, var(--accent), #ff8c55); color: white; }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,53,0.35); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  .err { color: var(--red); font-size: 0.82rem; margin-top: 0.5rem; text-align: center; }

  /* DASHBOARD */
  #dashboard { display: none; }
  .topbar {
    background: var(--card); border-bottom: 1px solid var(--border);
    padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .topbar-logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 2px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .logout-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0.4rem 0.9rem; color: var(--muted); font-size: 0.8rem; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
  .logout-btn:hover { color: var(--text); border-color: var(--accent); }

  .main { max-width: 1100px; margin: 0 auto; padding: 2rem; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem 1.4rem; }
  .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; line-height: 1; }
  .stat-lbl { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 0.3rem; }

  /* TABLE */
  .table-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
  .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 2px; }
  .refresh-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0.45rem 1rem; color: var(--text); font-size: 0.82rem; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; }
  .refresh-btn:hover { border-color: var(--accent); }

  .search-wrap { position: relative; }
  .search-wrap input {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 0.45rem 1rem 0.45rem 2.2rem; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; outline: none; width: 220px;
  }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 0.7rem; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.85rem; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.7rem 1rem; text-align: left; font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; white-space: nowrap; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover { background: rgba(255,107,53,0.04); }
  tbody td { padding: 0.85rem 1rem; font-size: 0.88rem; }
  .rank-cell { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: var(--muted); }
  .rank-cell.gold { color: #ffd23f; }
  .rank-cell.silver { color: #c0c0c8; }
  .rank-cell.bronze { color: #cd7f32; }
  .score-cell { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--accent); }
  .email-cell { color: var(--muted); font-size: 0.8rem; }
  .correct-cell { color: var(--green); font-weight: 600; }
  .wrong-cell { color: var(--red); font-weight: 600; }
  .del-btn { background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.25); border-radius: 6px; padding: 0.25rem 0.6rem; color: var(--red); font-size: 0.75rem; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
  .del-btn:hover { background: rgba(248,113,113,0.2); }

  .empty { text-align: center; padding: 3rem; color: var(--muted); }
  .loading { text-align: center; padding: 2rem; color: var(--muted); }

  .date-cell { font-size: 0.78rem; color: var(--muted); }

  /* EXPORT */
  .export-btn { background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.25); border-radius: 8px; padding: 0.45rem 1rem; color: var(--blue); font-size: 0.82rem; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; }
  .export-btn:hover { background: rgba(96,165,250,0.18); }

  /* SEKMELER */
  .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 0; }
  .tab-btn {
    background: none; border: none; color: var(--muted); font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; font-weight: 600; cursor: pointer; padding: 0.7rem 1.2rem;
    border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-btn:hover:not(.active) { color: var(--text); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* CANLI KONTROL */
  .live-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px;
    padding: 2rem; margin-bottom: 1.5rem;
  }
  .live-q-num {
    font-family: 'Bebas Neue', sans-serif; font-size: 5rem; line-height: 1;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 0.3rem;
  }
  .live-q-text { font-size: 1.05rem; font-weight: 500; line-height: 1.55; color: var(--text); margin-bottom: 1.5rem; }
  .live-q-opts { display: grid; gap: 0.5rem; margin-bottom: 1.5rem; }
  .live-q-opt {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.6rem 0.9rem; font-size: 0.88rem; color: var(--muted);
    display: flex; align-items: center; gap: 0.6rem;
  }
  .live-q-opt .opt-ltr {
    width: 24px; height: 24px; border-radius: 50%; background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 700; flex-shrink: 0;
  }
  .live-q-opt.correct-opt { border-color: var(--green); }
  .live-q-opt.correct-opt .opt-ltr { background: var(--green); color: white; }

  .waiting-count-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 1rem 1.4rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;
  }
  .waiting-count-num { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--accent2); line-height: 1; }
  .waiting-count-lbl { color: var(--muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; }

  .btn-next-q {
    width: 100%; padding: 1rem; border-radius: 12px; border: none; cursor: pointer;
    font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 2px;
    background: linear-gradient(135deg, var(--accent), #ff8c55); color: white;
    transition: all 0.2s;
  }
  .btn-next-q:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,107,53,0.4); }
  .btn-next-q:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-finish-q {
    width: 100%; padding: 0.85rem; border-radius: 12px; border: none; cursor: pointer;
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600;
    background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.3);
    color: var(--red); transition: all 0.2s;
  }
  .btn-finish-q:hover:not(:disabled) { background: rgba(248,113,113,0.2); }
  .btn-restart-q {
    width: 100%; padding: 0.85rem; border-radius: 12px; border: none; cursor: pointer;
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600;
    background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3);
    color: var(--blue); transition: all 0.2s;
  }
  .btn-restart-q:hover { background: rgba(96,165,250,0.2); }
  .live-progress { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--muted); margin-bottom: 0.5rem; }
  .live-badge { display: inline-block; padding: 0.2rem 0.65rem; border-radius: 99px; font-size: 0.72rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.75rem; }
  .live-status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 0.4rem; animation: blink 1.2s ease-in-out infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="login-panel">
  <div class="login-box">
    <div class="logo">GAG QUIZ</div>
    <div class="logo-sub">Admin Paneli</div>
    <div>
      <label>≈ûifre</label>
      <input type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()" />
      <button class="btn btn-primary" id="login-btn" onclick="doLogin()">Giri≈ü Yap</button>
      <div class="err" id="login-err"></div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-logo">GAG QUIZ ¬∑ Admin</div>
    <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
  </div>
  <div class="main">

    <!-- SEKMELER -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('tab-leaderboard', this)">üìä Sƒ±ralama</button>
      <button class="tab-btn" onclick="switchTab('tab-live', this)">üéÆ Canlƒ± Kontrol</button>
    </div>

    <!-- SIRALAM–ê SEKMESƒ∞ -->
    <div class="tab-panel active" id="tab-leaderboard">
      <!-- ƒ∞STATƒ∞STƒ∞KLER -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card"><div class="stat-val" id="s-total" style="color:var(--blue)">‚Äî</div><div class="stat-lbl">Toplam Katƒ±lƒ±mcƒ±</div></div>
        <div class="stat-card"><div class="stat-val" id="s-completed" style="color:var(--green)">‚Äî</div><div class="stat-lbl">Tamamlayan</div></div>
        <div class="stat-card"><div class="stat-val" id="s-avg" style="color:var(--accent2)">‚Äî</div><div class="stat-lbl">Ort. Puan</div></div>
        <div class="stat-card"><div class="stat-val" id="s-max" style="color:var(--accent)">‚Äî</div><div class="stat-lbl">En Y√ºksek Puan</div></div>
        <div class="stat-card"><div class="stat-val" id="s-correct" style="color:var(--green)">‚Äî</div><div class="stat-lbl">Ort. Doƒüru</div></div>
      </div>

      <!-- TABLO -->
      <div class="table-header">
        <div class="section-title">Sƒ±ralama Tablosu</div>
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
          <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-inp" placeholder="ƒ∞sim veya e-posta..." oninput="filterTable()" />
          </div>
          <button class="export-btn" onclick="exportCSV()">üì• CSV ƒ∞ndir</button>
          <button class="refresh-btn" onclick="loadData()">‚Üª Yenile</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ad Soyad</th>
              <th>E-posta</th>
              <th>Quiz Puanƒ±</th>
              <th>Ek Puan</th>
              <th>Toplam</th>
              <th>Doƒüru</th>
              <th>Tarih</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="lb-body">
            <tr><td colspan="9" class="loading">Y√ºkleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- CANLI KONTROL SEKMESƒ∞ -->
    <div class="tab-panel" id="tab-live">

      <!-- DURUM KARTI -->
      <div class="live-card" id="live-status-card">
        <div style="display:flex;align-items:center;margin-bottom:1.5rem;">
          <span class="live-status-dot" id="live-dot"></span>
          <span style="font-size:0.85rem;font-weight:700;letter-spacing:1px;" id="live-status-label">CANLI YARI≈ûMA</span>
          <span style="margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--muted);" id="live-q-counter">‚Äî / 25</span>
        </div>

        <div class="live-progress">
          <span id="live-prog-txt">Soru 1 / 25</span>
          <span id="live-badge-txt" class="live-badge badge-easy">Kolay ¬∑ 10 PT</span>
        </div>

        <div id="live-q-num" class="live-q-num">01</div>
        <div id="live-q-text" class="live-q-text">Y√ºkleniyor...</div>
        <div class="live-q-opts" id="live-q-opts"></div>

        <div class="waiting-count-box">
          <div>
            <div class="waiting-count-num" id="waiting-count">‚Äî</div>
            <div class="waiting-count-lbl">bu soruyu cevapladƒ±</div>
          </div>
          <div style="margin-left:auto;color:var(--muted);font-size:0.78rem;">Her 5sn'de g√ºncellenir</div>
        </div>

        <button class="btn-next-q" id="btn-next-q" onclick="adminNextQuestion()">
          SONRAKƒ∞ SORU ‚Üí
        </button>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-top:0.75rem;">
          <button class="btn-finish-q" onclick="adminFinishQuiz()">
            üèÅ Yarƒ±≈ümayƒ± Bitir
          </button>
          <button class="btn-restart-q" onclick="adminRestartQuiz()">
            üîÑ Ba≈ütan Ba≈ülat
          </button>
        </div>
      </div>

    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const API = "https://gagorganization.fun";

// =============================================
// SUPABASE YAPILANDIRMASI ‚Äî kendi bilgilerinle deƒüi≈ütir
// =============================================
const SUPABASE_URL = "https://rwognafwhzzynoamswpm.supabase.co";
// ‚ö†Ô∏è A≈üaƒüƒ±ya Supabase panelinden aldƒ±ƒüƒ±n ANON key'i yaz (service_role deƒüil!)
// Settings ‚Üí API ‚Üí "anon public" altƒ±ndaki key
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3b2duYWZ3aHp6eW5vYW1zd3BtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzE2NjksImV4cCI6MjA4NzQ0NzY2OX0.q6j5gyvcwGWWzOSyHZUv9llhwONRd3ppzvrsjFRLRow";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// =============================================

// Aynƒ± sorular (sƒ±ralama i√ßin)
const QUESTIONS = [
  { q: "√ñzge ni≈üanda oynayacak yer bulamazken ortada oynayan ki≈üi kimdir ?", opts: ["Annesi","Karde≈üi","Eren","Eltisi"], ans: 3 },
  { q: "Derin Talu annesi tatilde olduƒüu i√ßin ne i√ßememi≈ütir?", opts: ["Latte","Milkshake","Matcha","√áay"], ans: 2 },
  { q: "A≈üaƒüƒ±dakiler hangisi Yaƒüƒ±zJr nin eski sevgilisi deƒüildir?", opts: ["Berfinmis","√ñz√ºm Altƒ±n","Sudenaz Bulut","Beyza Aksoy"], ans: 3 },
  { q: "TikTok'un √áin'de kullanƒ±lan orijinal versiyonunun adƒ± nedir?", opts: ["Douyin","WeChat","Kwai","ClipGo"], ans: 0 },
  { q: "G√∂bek dansƒ± videolarƒ±yla d√ºnya √ßapƒ±nda viral olan TikTok fenomeni kimdir?", opts: ["√ñzdemirkol","Torlak","Yasin Cengiz","Onur Sermik"], ans: 2 },
  { q: "2026'da en √ßok takip√ßili TikTok fenomeni kimdir?", opts: ["Charli D'Amelio","Khaby Lame","Zach King","Addison Rae"], ans: 1 },
  { q: "A≈üagƒ±dakiler hangisi MEF'in Ev Arkada≈üƒ±ydƒ± ?", opts: ["Batuhan Yƒ±lmaz","Serdar Orta√ß","Onur Sermik","√ñzdemirkol"], ans: 0 },
  { q: "Cellat36 nƒ±n Tam ismi nedir ?", opts: ["Mehmet Deniz Cellat","√ñzg√ºr Deniz Cellat","√ñmer Deniz Cellat","Ozan Deniz Cellat"], ans: 1 },
  { q: "H√ºlya Mizgin'in √ßocuklarƒ±nƒ±n adƒ± nedir?", opts: ["Abdi ve Hira","Abdur ve Hera","Ayan ve Mira","Abdu ve Lara"], ans: 0 },
  { q: "Cansum Tatlƒ±'nƒ±n Kocasƒ±nƒ±n Adƒ± nedir ?", opts: ["Karabey","Yusufcan √ñcal","Sinan Kaya","Batuhan √áelik"], ans: 2 },
  { q: "Teslo Taylan a≈üaƒüƒ±dakilerden hangi ki≈üiye ev ziyareti yapmamƒ±≈ütƒ±r?", opts: ["Ankaralƒ± Batman","Medine","Yakƒ±≈üƒ±klƒ± g√ºvenlik","G√ºven Demir"], ans: 2 },
  { q: "Kƒ±≈ü Kƒ±zƒ±'nƒ±n e≈üinin adƒ± nedir?", opts: ["Hasan","Murat","Mehmet","H√ºseyin"], ans: 0 },
  { q: "Kadƒ±n kadƒ±n ‚Ä¶ en g√ºzel kadƒ±nƒ± diyen M√ºkremin gergin hangi yƒ±lƒ±n en g√ºzel kadƒ±nƒ±dƒ±r?", opts: ["2021","2023","2025","2024"], ans: 2 },
  { q: "Kƒ±≈ü kƒ±zƒ±nƒ±n karde≈üi Rabia'nƒ±n mesleƒüi nedir?", opts: ["A≈ü√ßƒ±","Ev Hanƒ±mƒ±","√ñƒürenci","Ba≈ühekim "], ans: 3 },
  { q: "√áoƒüu TikTok i√ßerik √ºreticisinin video √ßektiƒüi duvar hangi AVM'dedir?", opts: ["Marmarapark AVM","ANKAMALL","Optimum AVM","Cevahir AVM"], ans: 3 },
  { q: "Etkile≈üim i√ßin √ßocuk yapƒ±yor denilen ve hamileliƒüiyle g√ºndeme d√º≈üen Tiktoker Kimdir ?", opts: ["Dilan Polat","√ñzlem √ñz","Ceren Yaldƒ±z","H√ºlya Mizgin"], ans: 1 },
  { q: "TikTok'un ilk kurulduƒüu d√∂nemdeki adƒ± neydi ve hangi ≈üirket tarafƒ±ndan satƒ±n alƒ±ndƒ±?", opts: ["Vine ‚Äì Meta","Dubsmash ‚Äì Google","Musical.ly ‚Äì ByteDance","Triller ‚Äì Amazon"], ans: 2 },
  { q: "Arzu hanƒ±m ‚Ä¶.. c√ºmlesinin devamƒ± nedir?", opts: ["Efendim Fƒ±stƒ±k tanesi","Efendim Fƒ±ndƒ±k tanesi","Efendim kar tanesi","Kurabiye var simit var"], ans: 0 },
  { q: "Aƒülamaktan ay pardon lensten s√∂z√ºn√º kim s√∂ylemi≈ütir ?", opts: ["Cemre Solmaz","Buse Korkmaz","Berfinmis","Caƒülaca"], ans: 1 },
  { q: "Selin Ciƒüerci ve G√∂khan √áƒ±ra ili≈ükisinde en √ßok konu≈üulan ayrƒ±lƒ±k sebebi neydi?", opts: ["Futbol transferi","√ñzel hayat ve g√ºven problemleri iddialarƒ±","TikTok hesabƒ± y√∂netimi","TV programƒ± anla≈ümazlƒ±ƒüƒ±"], ans: 1 },
  { q: "Ceren Yaldƒ±zƒ±n emojisi nedir ?", opts: ["G√ºl","Yaprak","Kar Tanesi","Kurdele"], ans: 2 },
  { q: "Hangi Tiktokerin √ßocuklarƒ± canlƒ± yayƒ±nda Devlet tarafƒ±ndan alƒ±nmƒ±≈ütƒ±r ?", opts: ["Karag√ºl","H√ºlya Mizgin","Dilan Polat","√ñzlem √ñz"], ans: 0 },
  { q: "√únl√º Tiktokerlarƒ±n bir zaman i√ßinde bulunduklarƒ± evin adƒ± nedir?", opts: ["Glow House","TikTok House","Fenomen House","Fan House"], ans: 2 },
  { q: "Semiraminta Tiktok Takip√ßi Sayƒ±sƒ± ka√ßtƒ±r ?", opts: ["10.6 Milyon","8.4 Milyon","11.3 Milyon","12.6 Milyon"], ans: 3 },
  { q: "Kƒ±smetse Olur'da her g√ºn kavga edip barƒ±≈üan √ßift hangisidir?", opts: ["Belis-Barƒ±≈ü","Keren-Perinaz","Su- Metin","Ayla-Cemal"], ans: 0 },
];

let token = null;
let allData = [];
let liveCurrentQ = 0;
let waitingCountInterval = null;

async function doLogin() {
  const pass = document.getElementById('pass-input').value;
  const btn = document.getElementById('login-btn');
  document.getElementById('login-err').textContent = '';
  btn.disabled = true; btn.textContent = 'Giri≈ü yapƒ±lƒ±yor...';

  try {
    const res = await fetch(`${API}/api/admin/login`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password: pass })
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    token = data.token;
    document.getElementById('login-panel').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadData();
    initLiveControl();
  } catch {
    document.getElementById('login-err').textContent = '≈ûifre yanlƒ±≈ü veya sunucuya baƒülanƒ±lamadƒ±.';
    btn.disabled = false; btn.textContent = 'Giri≈ü Yap';
  }
}

// =============================================
// SEKME FONKSƒ∞YONLARI
// =============================================
function switchTab(tabId, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
}

// =============================================
// CANLI KONTROL
// =============================================
async function initLiveControl() {
  // Supabase'den mevcut durumu al
  const { data, error } = await supabaseClient
    .from('quiz_state')
    .select('current_question, is_active')
    .eq('id', 1)
    .single();

  if (error) {
    // Eƒüer kayƒ±t yoksa olu≈ütur
    await supabaseClient.from('quiz_state').upsert({ id: 1, current_question: 0, is_active: true });
    liveCurrentQ = 0;
  } else {
    liveCurrentQ = data.current_question || 0;
  }

  renderLiveQuestion();
  startWaitingCountPoll();
}

function renderLiveQuestion() {
  const dot = document.getElementById('live-dot');
  const label = document.getElementById('live-status-label');

  if (liveCurrentQ >= QUESTIONS.length) {
    // Yarƒ±≈üma bitti
    dot.style.background = 'var(--red)';
    dot.style.animation = 'none';
    label.style.color = 'var(--red)';
    label.textContent = 'YARI≈ûMA Bƒ∞TTƒ∞';
    document.getElementById('live-q-num').textContent = '‚úì';
    document.getElementById('live-q-text').textContent = 'T√ºm sorular tamamlandƒ±. Sonu√ßlar a√ßƒ±klanabilir.';
    document.getElementById('live-q-opts').innerHTML = '';
    document.getElementById('btn-next-q').disabled = true;
    document.getElementById('btn-next-q').textContent = 'TAMAMLANDI ‚úì';
    document.getElementById('live-q-counter').textContent = '25 / 25';
    document.getElementById('live-prog-txt').textContent = 'Tamamlandƒ±';
    clearInterval(waitingCountInterval);
    return;
  }

  // Normal durum
  dot.style.background = 'var(--green)';
  dot.style.animation = 'blink 1.2s ease-in-out infinite';
  label.style.color = 'var(--green)';
  label.textContent = 'CANLI YARI≈ûMA';

  const q = QUESTIONS[liveCurrentQ];
  const letters = ['A','B','C','D'];
  const badges = liveCurrentQ < 10
    ? ['badge-easy','Kolay ¬∑ 10 PT']
    : liveCurrentQ < 20
      ? ['badge-medium','Orta ¬∑ 20 PT']
      : ['badge-hard','Zor ¬∑ 30 PT'];

  document.getElementById('live-q-num').textContent = String(liveCurrentQ+1).padStart(2,'0');
  document.getElementById('live-q-text').textContent = q.q;
  document.getElementById('live-q-counter').textContent = `${liveCurrentQ+1} / 25`;
  document.getElementById('live-prog-txt').textContent = `Soru ${liveCurrentQ+1} / 25`;

  const badgeEl = document.getElementById('live-badge-txt');
  badgeEl.className = 'live-badge ' + badges[0];
  badgeEl.textContent = badges[1];

  const optsContainer = document.getElementById('live-q-opts');
  optsContainer.innerHTML = q.opts.map((opt, i) =>
    `<div class="live-q-opt ${i === q.ans ? 'correct-opt' : ''}">
      <div class="opt-ltr">${letters[i]}</div>
      <div style="color:${i === q.ans ? 'var(--green)' : 'var(--muted)'};">${opt}</div>
      ${i === q.ans ? '<span style="margin-left:auto;color:var(--green);font-size:0.75rem;font-weight:700;">‚úì DOƒûRU</span>' : ''}
    </div>`
  ).join('');

  document.getElementById('btn-next-q').disabled = false;
  document.getElementById('btn-next-q').textContent = liveCurrentQ < QUESTIONS.length - 1
    ? 'SONRAKƒ∞ SORU ‚Üí'
    : "QUIZ'ƒ∞ Bƒ∞Tƒ∞R ‚Üí";
}

async function adminNextQuestion() {
  const btn = document.getElementById('btn-next-q');
  btn.disabled = true;

  const nextQ = liveCurrentQ + 1;
  const isLast = nextQ >= QUESTIONS.length;

  const { error } = await supabaseClient
    .from('quiz_state')
    .update({ current_question: isLast ? QUESTIONS.length : nextQ, is_active: !isLast })
    .eq('id', 1);

  if (error) {
    alert('Supabase g√ºncelleme hatasƒ±: ' + error.message);
    btn.disabled = false;
    return;
  }

  if (isLast) {
    liveCurrentQ = QUESTIONS.length;
    renderLiveQuestion();
    clearInterval(waitingCountInterval);
  } else {
    liveCurrentQ = nextQ;
    renderLiveQuestion();
  }
}

async function adminFinishQuiz() {
  if (!confirm('Yarƒ±≈ümayƒ± bitirmek istediƒüinizden emin misiniz? T√ºm katƒ±lƒ±mcƒ±lar sonu√ß ekranƒ±na ge√ßecek.')) return;
  await supabaseClient.from('quiz_state').update({ is_active: false, current_question: QUESTIONS.length }).eq('id', 1);
  clearInterval(waitingCountInterval);
  liveCurrentQ = QUESTIONS.length;
  renderLiveQuestion();
}

async function adminRestartQuiz() {
  if (!confirm('Yarƒ±≈ümayƒ± BA≈ûTAN ba≈ülatmak istediƒüinizden emin misiniz? Herkes 1. soruya d√∂necek.')) return;
  const { error } = await supabaseClient
    .from('quiz_state')
    .update({ current_question: 0, is_active: true })
    .eq('id', 1);
  if (error) { alert('Hata: ' + error.message); return; }
  liveCurrentQ = 0;
  renderLiveQuestion();
  startWaitingCountPoll();
}

async function fetchWaitingCount() {
  try {
    const res = await fetch(`${API}/api/admin/waiting-count?q=${liveCurrentQ}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const data = await res.json();
    document.getElementById('waiting-count').textContent = data.count ?? '?';
  } catch {
    // sessizce ge√ß
  }
}

function startWaitingCountPoll() {
  fetchWaitingCount();
  waitingCountInterval = setInterval(fetchWaitingCount, 5000);
}

async function loadData() {
  await Promise.all([loadStats(), loadLeaderboard()]);
}

async function loadStats() {
  try {
    const res = await fetch(`${API}/api/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    document.getElementById('s-total').textContent = data.total_participants;
    document.getElementById('s-completed').textContent = data.total_completed;
    document.getElementById('s-avg').textContent = data.avg_score;
    document.getElementById('s-max').textContent = data.max_score;
    document.getElementById('s-correct').textContent = data.avg_correct + ' / 25';
  } catch {}
}

async function loadLeaderboard() {
  const tbody = document.getElementById('lb-body');
  tbody.innerHTML = '<tr><td colspan="9" class="loading">Y√ºkleniyor...</td></tr>';
  try {
    const res = await fetch(`${API}/api/admin/leaderboard`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    allData = data.data || [];
    renderTable(allData);
  } catch {
    tbody.innerHTML = '<tr><td colspan="9" class="empty">Veri alƒ±namadƒ±.</td></tr>';
  }
}

function renderTable(data) {
  const tbody = document.getElementById('lb-body');
  if (!data.length) { tbody.innerHTML = '<tr><td colspan="9" class="empty">Hen√ºz katƒ±lƒ±mcƒ± yok.</td></tr>'; return; }
  const rankColors = ['gold','silver','bronze'];
  tbody.innerHTML = data.map((r, i) => {
    const date = r.submitted_at ? new Date(r.submitted_at).toLocaleDateString('tr-TR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    const ekPuan = (r.extra_score != null) ? r.extra_score : '‚Äî';
    const toplam = (r.total_score != null) ? r.total_score : r.score;
    return `<tr>
      <td class="rank-cell ${rankColors[i]||''}">${i+1}</td>
      <td><strong>${escHtml(r.name)}</strong></td>
      <td class="email-cell">${escHtml(r.email)}</td>
      <td class="score-cell">${r.score}</td>
      <td style="color:var(--accent2);font-weight:700;font-size:1.1rem;">${ekPuan}</td>
      <td style="color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;">${toplam}</td>
      <td class="correct-cell">${r.correct}</td>
      <td class="date-cell">${date}</td>
      <td><button class="del-btn" onclick="deleteEntry('${escHtml(r.email)}')">Sil</button></td>
    </tr>`;
  }).join('');
}

function filterTable() {
  const q = document.getElementById('search-inp').value.toLowerCase();
  const filtered = allData.filter(r => r.name.toLowerCase().includes(q) || r.email.toLowerCase().includes(q));
  renderTable(filtered);
}

async function deleteEntry(email) {
  if (!confirm(`${email} kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) return;
  try {
    await fetch(`${API}/api/admin/result/${encodeURIComponent(email)}`, {
      method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
    });
    allData = allData.filter(r => r.email !== email);
    renderTable(allData);
    loadStats();
  } catch { alert('Silme i≈ülemi ba≈üarƒ±sƒ±z.'); }
}

function exportCSV() {
  if (!allData.length) { alert('Dƒ±≈üa aktarƒ±lacak veri yok.'); return; }
  const header = ['Sƒ±ra','Ad Soyad','E-posta','Puan','Doƒüru','Yanlƒ±≈ü','Tarih'];
  const rows = allData.map((r, i) => [
    i+1, r.name, r.email, r.score, r.correct, r.wrong,
    r.submitted_at ? new Date(r.submitted_at).toLocaleDateString('tr-TR') : ''
  ]);
  const csv = [header, ...rows].map(row => row.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `gag_quiz_${new Date().toLocaleDateString('tr-TR').replace(/\./g,'-')}.csv`;
  a.click();
}

function logout() {
  token = null; allData = [];
  clearInterval(waitingCountInterval);
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-panel').style.display = 'flex';
  document.getElementById('pass-input').value = '';
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
