<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAG Quiz â€” Ek Sorular</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #13131a; --card: #1a1a24; --border: #2a2a38;
    --accent: #ff6b35; --accent2: #ffd23f; --text: #e8e8f0; --muted: #666680;
    --green: #4ade80; --red: #f87171;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 70% 20%, rgba(255,107,53,0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 20% 80%, rgba(255,210,63,0.05) 0%, transparent 40%);
    pointer-events: none; z-index: 0;
  }
  .container { max-width: 640px; margin: 0 auto; padding: 2rem 1.5rem; position: relative; z-index: 1; }
  .logo-wrap { text-align: center; margin-bottom: 0.5rem; }
  .logo-wrap img { height: 80px; width: auto; }
  .tagline { text-align: center; font-size: 1rem; letter-spacing: 4px; color: var(--accent); font-weight: 700; margin-bottom: 0.3rem; }
  .tagline2 { text-align: center; font-size: 0.75rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 3rem; }
  .screen { display: none; animation: fadeIn 0.35s ease; }
  .screen.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; }
  label { display: block; font-size: 0.75rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.5rem; }
  input[type="email"] {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 0.85rem 1rem; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 1rem; outline: none; transition: border-color 0.2s;
  }
  input:focus { border-color: var(--accent); }
  .form-group { margin-bottom: 1.2rem; }
  .btn { width: 100%; padding: 0.9rem; border-radius: 10px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 600; transition: all 0.2s; }
  .btn-primary { background: linear-gradient(135deg, var(--accent), #ff8c55); color: white; }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,107,53,0.35); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  .error { color: var(--red); font-size: 0.82rem; margin-top: 0.4rem; }
  .badge { display: inline-block; padding: 0.2rem 0.65rem; border-radius: 99px; font-size: 0.72rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .badge-hard { background: rgba(255,107,53,0.15); color: var(--accent); border: 1px solid rgba(255,107,53,0.3); }
  .quiz-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
  .progress-wrap { background: var(--surface); border-radius: 99px; height: 5px; margin-bottom: 0.8rem; overflow: hidden; }
  .progress-bar { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width 0.4s ease; }
  .progress-info { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--muted); margin-bottom: 1.5rem; }
  .btn-next { margin-top: 1.2rem; display: none; }
  .btn-next.show { display: block; }
  .q-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
  .q-num { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; color: var(--accent); line-height: 1; flex-shrink: 0; }
  .q-text { font-size: 1.05rem; font-weight: 500; line-height: 1.55; padding-top: 0.2rem; }
  .options { display: grid; gap: 0.65rem; }
  .option { background: var(--surface); border: 1.5px solid var(--border); border-radius: 10px; padding: 0.85rem 1rem; cursor: pointer; transition: all 0.18s; display: flex; align-items: center; gap: 0.8rem; font-size: 0.92rem; }
  .option:hover:not(.disabled) { border-color: var(--accent); background: rgba(255,107,53,0.07); }
  .option.selected { border-color: var(--accent); background: rgba(255,107,53,0.12); }
  .option.disabled { pointer-events: none; }
  .opt-letter { width: 28px; height: 28px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 700; flex-shrink: 0; }
  .option.selected .opt-letter { background: var(--accent); color: white; }
  .info-box { background: rgba(255,210,63,0.08); border: 1px solid rgba(255,210,63,0.25); border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1.5rem; font-size: 0.88rem; color: var(--accent2); }
  /* Bekleme */
  .waiting-screen { text-align: center; padding: 3rem 2rem; }
  .waiting-icon { font-size: 3rem; margin-bottom: 1.2rem; animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.08);opacity:0.7} }
  .waiting-title { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 3px; margin-bottom: 0.8rem; color: var(--accent2); }
  .waiting-msg { font-size: 0.95rem; color: var(--muted); line-height: 1.7; }
  .dots::after { content: ''; animation: dots 1.5s steps(4,end) infinite; }
  @keyframes dots { 0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} }
</style>
</head>
<body>
<div class="container">
  <div class="logo-wrap">
    <img src="https://gagorganization.fun/logo" style="height:80px;width:auto;" alt="GAG Organization" onerror="this.style.display='none'" />
  </div>
  <div class="tagline">TikTok Quiz</div>
  <div class="tagline2">Ek Sorular Â· EÅŸitlik Bozucu</div>

  <!-- GÄ°RÄ°Å -->
  <div class="screen active" id="screen-login">
    <div class="info-box">
      âš¡ Bu sayfa yalnÄ±zca yÃ¶netici tarafÄ±ndan yÃ¶nlendirilen katÄ±lÄ±mcÄ±lar iÃ§indir. Quiz'de eÅŸit puan alan katÄ±lÄ±mcÄ±lar bu sorularla sÄ±ralanacak.
    </div>
    <div class="card">
      <h2 style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:2px;margin-bottom:0.3rem;">E-posta ile GiriÅŸ</h2>
      <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1.5rem;">Quiz'de kullandÄ±ÄŸÄ±nÄ±z e-posta adresinizi girin.</p>
      <div class="form-group">
        <label>E-posta</label>
        <input type="email" id="inp-email" placeholder="ornek@mail.com" />
        <div class="error" id="err-email"></div>
      </div>
      <button class="btn btn-primary" id="btn-login" onclick="handleLogin()">GiriÅŸ Yap â†’</button>
    </div>
  </div>

  <!-- EK SORULAR BAÅLAMADIYSA BEKLE -->
  <div class="screen" id="screen-waiting-start">
    <div class="card waiting-screen">
      <div class="waiting-icon">â³</div>
      <div class="waiting-title">HazÄ±r Ol!</div>
      <div class="waiting-msg">
        Ek sorular henÃ¼z baÅŸlamadÄ±.<br>
        Admin baÅŸlattÄ±ÄŸÄ±nda otomatik olarak geÃ§eceksin<span class="dots"></span>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="screen" id="screen-quiz">
    <div class="quiz-top">
      <span class="badge badge-hard">Ek Soru Â· 10 PT</span>
    </div>
    <div class="progress-wrap"><div class="progress-bar" id="prog-bar" style="width:0%"></div></div>
    <div class="progress-info">
      <span id="prog-text">Ek Soru 1 / 10</span>
      <span></span>
    </div>
    <div class="card">
      <div class="q-header">
        <div class="q-num" id="q-num">01</div>
        <div class="q-text" id="q-text"></div>
      </div>
      <div class="options" id="opts"></div>
      <button class="btn btn-primary btn-next" id="btn-next" onclick="confirmPick()">Devam Et â†’</button>
    </div>
  </div>

  <!-- CEVAP VERÄ°LDÄ° â€” ADMÄ°N BEKLENÄ°YOR -->
  <div class="screen" id="screen-waiting">
    <div class="card waiting-screen">
      <div class="waiting-icon">âœ…</div>
      <div class="waiting-title">CevabÄ±nÄ±z AlÄ±ndÄ±!</div>
      <div class="waiting-msg">
        Admin bir sonraki soruyu baÅŸlatmayÄ± bekliyor<span class="dots"></span>
      </div>
    </div>
  </div>

  <!-- SONUÃ‡ -->
  <div class="screen" id="screen-result">
    <div class="card" style="text-align:center;padding:3rem 2rem;">
      <div style="font-size:3.5rem;margin-bottom:1.2rem;">ğŸ</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:0.8rem;color:var(--text);">Ek Sorular Bitti!</div>
      <div style="font-size:1.05rem;color:var(--muted);line-height:1.7;">
        CevaplarÄ±nÄ±z kaydedildi.<br>
        <span style="color:var(--accent);font-weight:600;">SonuÃ§lar admin tarafÄ±ndan aÃ§Ä±klanacak. ğŸ‘€</span>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const API = "https://gagorganization.fun";
const SUPABASE_URL = "https://rwognafwhzzynoamswpm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3b2duYWZ3aHp6eW5vYW1zd3BtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzE2NjksImV4cCI6MjA4NzQ0NzY2OX0.q6j5gyvcwGWWzOSyHZUv9llhwONRd3ppzvrsjFRLRow";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const EK_SORULAR = [
  { q: "HaliliÅŸko patates yemeyi bÄ±raktÄ±ktan sonra hangi yemeÄŸi daha Ã§ok sevmiÅŸtir?", opts: ["Makarna","Tost","Yumurta","Ekmek"], ans: 1 },
  { q: "Kabede HacÄ±lar Hu Der Allah Ä°lahisiyle GÃ¼ndeme Gelen KiÅŸi Kimdir ?", opts: ["Caner","Cemal","Cemil","Celal"], ans: 3 },
  { q: "GAG Organizasyon Tiktok sayfasÄ±nÄ±n en Ã§ok izlenen videosu hangisidir?", opts: ["Wegh Hallowen AfiÅŸ","Noel Party AfiÅŸ","Erkolar KapatÄ±ldÄ± Party AfiÅŸ","Big Final2 Party AfiÅŸ"], ans: 2 },
  { q: "Ecrin Su Ã‡obanÄ±n son ÅŸarkÄ±sÄ±nÄ±n adÄ± nedir ?", opts: ["Karma","Masallar Kadar GÃ¼zel","Masallar Ä°nan","Pembe GÃ¼nlÃ¼ÄŸÃ¼m"], ans: 0 },
  { q: "BerkeJuanÄ±n kÄ±sa sÃ¼re Ã¶nce evlendiÄŸi kiÅŸi kimdir ?", opts: ["Yaren Alaca","Aysude","Elif ArmaÄŸan","Beste Kelkit"], ans: 3 },
  { q: "Fenomen House de Bulanan Taylan Aslen nerelidir ?", opts: ["TÃ¼rkiye","Kazakistan","TÃ¼rkmenistan","Afganistan"], ans: 3 },
  { q: "Dubai'de TÃ¼rk fenomenlerle ilgili 2026'da yaÅŸanan olay nedir?", opts: ["Ortak bir mÃ¼zik projesi","Fenomenler arasÄ±nda kavga gÃ¶rÃ¼ntÃ¼lerinin yayÄ±lmasÄ±","UluslararasÄ± Ã¶dÃ¼l tÃ¶reni","TikTok Shop lansmanÄ±"], ans: 1 },
  { q: "Erol YÄ±ldÄ±rÄ±m 'Sen beni her gÃ¶rdÃ¼ÄŸÃ¼nde ... olucaksÄ±n' demiÅŸtir?", opts: ["ÃœzÃ¼leceksin","AÄŸlaycaksÄ±n","KahrolacaksÄ±n","KÄ±skanacaksÄ±n"], ans: 2 },
  { q: "TikTok hangi yÄ±l global olarak piyasaya sÃ¼rÃ¼ldÃ¼?", opts: ["2016","2014","2018","2017"], ans: 0 },
  { q: "KÄ±smetse Olur ilk sezon ÅŸampiyonu Kimdir ?", opts: ["Nur ErkoÃ§ ve Batuhan","Cansel Ã‡Ã¶rdÃ¼k ve Eser","Elif ve Sedat","AyÃ§a ve Emre"], ans: 1 },
];

// ================================================================
// STATE
// ================================================================
let userEmail = null;
let localQIdx = 0;        // son gÃ¶sterilen soru indeksi
let score = 0;
let selectedIdx = null;
let quizFinished = false;
let realtimeChannel = null;
let pollInterval = null;

// ================================================================
// GÄ°RÄ°Å
// ================================================================
async function handleLogin() {
  const email = document.getElementById('inp-email').value.trim();
  document.getElementById('err-email').textContent = '';
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById('err-email').textContent = 'GeÃ§erli e-posta girin.';
    return;
  }
  const btn = document.getElementById('btn-login');
  btn.disabled = true;
  btn.textContent = 'Kontrol ediliyor...';
  try {
    const res = await fetch(`${API}/api/check-user?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    if (!data.exists) {
      document.getElementById('err-email').textContent = "Bu e-posta ana quiz'de kayÄ±tlÄ± deÄŸil.";
      btn.disabled = false; btn.textContent = 'GiriÅŸ Yap â†’';
      return;
    }
    if (data.already_done) {
      document.getElementById('err-email').textContent = 'Bu e-posta ile ek sorular zaten tamamlandÄ±.';
      btn.disabled = false; btn.textContent = 'GiriÅŸ Yap â†’';
      return;
    }
    userEmail = email;
    await checkAndApplyState();
  } catch (e) {
    document.getElementById('err-email').textContent = 'Sunucuya baÄŸlanÄ±lamadÄ±.';
    btn.disabled = false; btn.textContent = 'GiriÅŸ Yap â†’';
  }
}

// ================================================================
// SUPABASE STATE OKU & UYGULA
// ================================================================
async function checkAndApplyState() {
  try {
    const { data, error } = await supabaseClient
      .from('extra_quiz_state')
      .select('*')
      .eq('id', 1)
      .single();
    if (error || !data) throw new Error('no data');
    applyState(data);
  } catch {
    // Tablo yok ya da satÄ±r yok â†’ henÃ¼z baÅŸlamadÄ±
    showScreen('waiting-start');
    startPolling();
  }
}

function applyState(state) {
  if (!state) return;

  const serverQ = state.current_question || 0;
  const isActive = state.is_active || false;

  // Bitti mi?
  if (serverQ >= EK_SORULAR.length && !quizFinished) {
    finishQuiz();
    return;
  }

  // Aktif deÄŸil â†’ bekle
  if (!isActive) {
    if (!document.getElementById('screen-waiting-start').classList.contains('active')) {
      showScreen('waiting-start');
    }
    startPolling();
    return;
  }

  // Aktif: soru indeksimiz sunucudan gerideyse yeni soruya geÃ§
  if (serverQ > localQIdx || document.getElementById('screen-waiting-start').classList.contains('active')) {
    localQIdx = serverQ;
    stopPolling();
    showScreen('quiz');
    renderQ();
    startRealtime();
    return;
  }

  // Bekleme ekranÄ±ndaysak ve soru ilerlediyse
  if (document.getElementById('screen-waiting').classList.contains('active') && serverQ > localQIdx) {
    localQIdx = serverQ;
    stopPolling();
    showScreen('quiz');
    renderQ();
    startRealtime();
  }
}

// ================================================================
// REALTIME
// ================================================================
function startRealtime() {
  if (realtimeChannel) supabaseClient.removeChannel(realtimeChannel);
  realtimeChannel = supabaseClient
    .channel('extra_qs_rt_' + Math.random())
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'extra_quiz_state',
      filter: 'id=eq.1'
    }, (payload) => {
      applyState(payload.new);
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        stopPolling();
      } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        startPolling();
      }
    });
}

// ================================================================
// POLLING (Realtime fallback, sadece bekleme ekranÄ±nda)
// ================================================================
function startPolling() {
  if (pollInterval) return;
  pollInterval = setInterval(async () => {
    try {
      const { data } = await supabaseClient
        .from('extra_quiz_state')
        .select('*')
        .eq('id', 1)
        .single();
      if (data) applyState(data);
    } catch {}
  }, 2000);
}

function stopPolling() {
  if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
}

// ================================================================
// QUIZ RENDER
// ================================================================
function renderQ() {
  selectedIdx = null;
  const q = EK_SORULAR[localQIdx];
  document.getElementById('q-num').textContent = String(localQIdx + 1).padStart(2, '0');
  document.getElementById('q-text').textContent = q.q;
  document.getElementById('prog-text').textContent = `Ek Soru ${localQIdx + 1} / ${EK_SORULAR.length}`;
  document.getElementById('prog-bar').style.width = ((localQIdx / EK_SORULAR.length) * 100) + '%';

  const letters = ['A', 'B', 'C', 'D'];
  const container = document.getElementById('opts');
  container.innerHTML = '';
  q.opts.forEach((opt, i) => {
    const el = document.createElement('div');
    el.className = 'option';
    el.innerHTML = `<div class="opt-letter">${letters[i]}</div><div>${opt}</div>`;
    el.onclick = () => pick(i, el);
    container.appendChild(el);
  });
  document.getElementById('btn-next').classList.remove('show');
}

function pick(idx, el) {
  document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedIdx = idx;
  document.getElementById('btn-next').classList.add('show');
}

async function confirmPick() {
  if (selectedIdx === null) return;

  // SeÃ§imi kilitle
  document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));
  document.getElementById('btn-next').classList.remove('show');

  // PuanÄ± hesapla
  if (selectedIdx === EK_SORULAR[localQIdx].ans) score += 10;

  // Son soruysa direkt bitir
  if (localQIdx + 1 >= EK_SORULAR.length) {
    await finishQuiz();
  } else {
    // Admin sonraki soruyu aÃ§ana kadar bekle
    showScreen('waiting');
    startPolling();
  }
}

async function finishQuiz() {
  if (quizFinished) return;
  quizFinished = true;
  stopPolling();
  if (realtimeChannel) {
    supabaseClient.removeChannel(realtimeChannel);
    realtimeChannel = null;
  }
  try {
    await fetch(`${API}/api/submit-extra`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: userEmail, extra_score: score })
    });
  } catch {}
  showScreen('result');
}

// ================================================================
// YARDIMCI
// ================================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}
</script>
</body>
</html>
